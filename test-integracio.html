<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test d'Integraci√≥ - BancSang</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            color: #d32f2f;
            margin-top: 0;
        }

        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .test-result.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }

        .test-result.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }

        button {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #b71c1c;
        }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>üß™ Test d'Integraci√≥ del Sistema</h1>

    <div class="test-section">
        <h2>1. Verificaci√≥ de Scripts Carregats</h2>
        <div id="scriptsTest"></div>
    </div>

    <div class="test-section">
        <h2>2. Test d'Autenticaci√≥</h2>
        <button onclick="testAuth()">Executar Test</button>
        <div id="authTest"></div>
    </div>

    <div class="test-section">
        <h2>3. Test de Gesti√≥ de Dades d'Usuari</h2>
        <button onclick="testUserData()">Executar Test</button>
        <div id="userDataTest"></div>
    </div>

    <div class="test-section">
        <h2>4. Test de Donacions</h2>
        <button onclick="testDonations()">Executar Test</button>
        <div id="donationsTest"></div>
    </div>

    <div class="test-section">
        <h2>5. Test de Notificacions</h2>
        <button onclick="testNotifications()">Executar Test</button>
        <div id="notificationsTest"></div>
    </div>

    <div class="test-section">
        <h2>6. Test de Calendari</h2>
        <button onclick="testCalendar()">Executar Test</button>
        <div id="calendarTest"></div>
    </div>

    <div class="test-section">
        <h2>7. Test de Coher√®ncia</h2>
        <button onclick="testCoherence()">Executar Test Complet</button>
        <div id="coherenceTest"></div>
    </div>

    <script src="scripts/user-data-manager.js"></script>
    <script src="scripts/auth.js"></script>

    <script>
        // Funcions auxiliars
        function addResult(containerId, success, message, details = '') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${success ? 'success' : 'error'}`;
            result.innerHTML = `
                <strong>${success ? '‚úÖ' : '‚ùå'} ${message}</strong>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            container.appendChild(result);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        // Test 1: Scripts carregats
        window.addEventListener('DOMContentLoaded', () => {
            const scriptsTest = document.getElementById('scriptsTest');

            // Verificar UserDataManager
            if (typeof UserDataManager !== 'undefined') {
                addResult('scriptsTest', true, 'UserDataManager carregat correctament');
            } else {
                addResult('scriptsTest', false, 'UserDataManager NO carregat');
            }

            // Verificar AuthManager
            if (typeof AuthManager !== 'undefined') {
                addResult('scriptsTest', true, 'AuthManager carregat correctament');
            } else {
                addResult('scriptsTest', false, 'AuthManager NO carregat');
            }
        });

        // Test 2: Autenticaci√≥
        function testAuth() {
            clearResults('authTest');

            try {
                // Test login amb usuari demo
                const result = AuthManager.login('demo@exemple.com', 'password1234');

                if (result.success) {
                    addResult('authTest', true, 'Login correcte',
                        `Usuari: ${result.user.name}\nEmail: ${result.user.email}`);

                    // Verificar sessi√≥
                    const session = AuthManager.getCurrentSession();
                    if (session && session.userId) {
                        addResult('authTest', true, 'Sessi√≥ creada correctament',
                            `UserId: ${session.userId}`);
                    } else {
                        addResult('authTest', false, 'Sessi√≥ NO creada');
                    }
                } else {
                    addResult('authTest', false, 'Login fallit', result.message);
                }
            } catch (error) {
                addResult('authTest', false, 'Error en test d\'autenticaci√≥', error.message);
            }
        }

        // Test 3: Gesti√≥ de dades d'usuari
        function testUserData() {
            clearResults('userDataTest');

            try {
                // Assegurar que hi ha sessi√≥
                if (!AuthManager.isAuthenticated()) {
                    AuthManager.login('demo@exemple.com', 'password1234');
                }

                // Test obtenir dades
                const userData = UserDataManager.getCurrentUserData();

                if (userData) {
                    addResult('userDataTest', true, 'Dades d\'usuari obtingudes',
                        `Nom: ${userData.profile.name}\nDonacions: ${userData.donations.totalCount}`);

                    // Verificar estructura
                    const hasProfile = userData.profile !== undefined;
                    const hasDonations = userData.donations !== undefined;
                    const hasNotifications = userData.notifications !== undefined;
                    const hasCalendar = userData.calendar !== undefined;

                    if (hasProfile && hasDonations && hasNotifications && hasCalendar) {
                        addResult('userDataTest', true, 'Estructura de dades correcta');
                    } else {
                        addResult('userDataTest', false, 'Estructura de dades incompleta',
                            `Profile: ${hasProfile}\nDonations: ${hasDonations}\nNotifications: ${hasNotifications}\nCalendar: ${hasCalendar}`);
                    }
                } else {
                    addResult('userDataTest', false, 'No s\'han pogut obtenir les dades');
                }
            } catch (error) {
                addResult('userDataTest', false, 'Error en test de dades', error.message);
            }
        }

        // Test 4: Donacions
        function testDonations() {
            clearResults('donationsTest');

            try {
                // Assegurar autenticaci√≥
                if (!AuthManager.isAuthenticated()) {
                    AuthManager.login('demo@exemple.com', 'password1234');
                }

                const initialData = UserDataManager.getCurrentUserData();
                const initialCount = initialData.donations.totalCount;

                // Afegir donaci√≥ de test
                const testDonation = {
                    date: new Date().toISOString().split('T')[0],
                    center: 'Hospital Test',
                    type: 'Sang',
                    volume: 450,
                    observations: 'Test de sistema'
                };

                UserDataManager.addDonation(testDonation);

                // Verificar
                const afterData = UserDataManager.getCurrentUserData();
                const newCount = afterData.donations.totalCount;

                if (newCount === initialCount + 1) {
                    addResult('donationsTest', true, 'Donaci√≥ afegida correctament',
                        `Donacions totals: ${newCount}`);

                    // Verificar √∫ltima donaci√≥
                    const lastDonation = afterData.donations.list[afterData.donations.list.length - 1];
                    if (lastDonation.center === 'Hospital Test') {
                        addResult('donationsTest', true, 'Dades de donaci√≥ correctes');
                    } else {
                        addResult('donationsTest', false, 'Dades de donaci√≥ incorrectes');
                    }
                } else {
                    addResult('donationsTest', false, 'Error afegint donaci√≥',
                        `Esperat: ${initialCount + 1}, Obtingut: ${newCount}`);
                }
            } catch (error) {
                addResult('donationsTest', false, 'Error en test de donacions', error.message);
            }
        }

        // Test 5: Notificacions
        function testNotifications() {
            clearResults('notificationsTest');

            try {
                if (!AuthManager.isAuthenticated()) {
                    AuthManager.login('demo@exemple.com', 'password1234');
                }

                const initialData = UserDataManager.getCurrentUserData();
                const initialCount = initialData.notifications.list.length;

                // Afegir notificaci√≥ de test
                UserDataManager.addNotification({
                    type: 'info',
                    icon: 'üß™',
                    iconClass: 'info',
                    title: 'Notificaci√≥ de Test',
                    description: 'Aquesta √©s una notificaci√≥ de prova del sistema',
                    time: 'Ara mateix',
                    date: 'Avui',
                    category: 'Test',
                    priority: 'low'
                });

                // Verificar
                const afterData = UserDataManager.getCurrentUserData();
                const newCount = afterData.notifications.list.length;

                if (newCount === initialCount + 1) {
                    addResult('notificationsTest', true, 'Notificaci√≥ afegida correctament',
                        `Notificacions totals: ${newCount}`);
                } else {
                    addResult('notificationsTest', false, 'Error afegint notificaci√≥');
                }

                // Test obtenir notificacions
                const notifications = UserDataManager.getNotifications();
                if (Array.isArray(notifications)) {
                    addResult('notificationsTest', true, 'Obtenir notificacions funciona');
                } else {
                    addResult('notificationsTest', false, 'Error obtenint notificacions');
                }
            } catch (error) {
                addResult('notificationsTest', false, 'Error en test de notificacions', error.message);
            }
        }

        // Test 6: Calendari
        function testCalendar() {
            clearResults('calendarTest');

            try {
                if (!AuthManager.isAuthenticated()) {
                    AuthManager.login('demo@exemple.com', 'password1234');
                }

                const initialData = UserDataManager.getCurrentUserData();
                const initialCount = initialData.calendar.appointments.length;

                // Afegir cita de test
                const testAppointment = {
                    date: new Date().toISOString().split('T')[0],
                    time: '10:00',
                    center: 'Hospital Test',
                    type: 'appointment',
                    title: 'Cita de Test',
                    donationType: 'Sang'
                };

                UserDataManager.addCalendarAppointment(testAppointment);

                // Verificar
                const afterData = UserDataManager.getCurrentUserData();
                const newCount = afterData.calendar.appointments.length;

                if (newCount === initialCount + 1) {
                    addResult('calendarTest', true, 'Cita afegida correctament',
                        `Cites totals: ${newCount}`);
                } else {
                    addResult('calendarTest', false, 'Error afegint cita');
                }

                // Test loadDonationsToCalendar
                const events = UserDataManager.loadDonationsToCalendar();
                if (Array.isArray(events)) {
                    addResult('calendarTest', true,
                        'loadDonationsToCalendar funciona',
                        `Events carregats: ${events.length}`);
                } else {
                    addResult('calendarTest', false, 'Error carregant esdeveniments');
                }
            } catch (error) {
                addResult('calendarTest', false, 'Error en test de calendari', error.message);
            }
        }

        // Test 7: Coher√®ncia completa
        function testCoherence() {
            clearResults('coherenceTest');

            try {
                if (!AuthManager.isAuthenticated()) {
                    AuthManager.login('demo@exemple.com', 'password1234');
                }

                const beforeData = UserDataManager.getCurrentUserData();
                const beforeDonations = beforeData.donations.totalCount;
                const beforeNotifications = beforeData.notifications.list.length;
                const beforeEvents = beforeData.calendar.appointments.length;

                addResult('coherenceTest', true, 'Estat inicial',
                    `Donacions: ${beforeDonations}\nNotificacions: ${beforeNotifications}\nEventos: ${beforeEvents}`);

                // Afegir una donaci√≥ (hauria de crear notificacions i esdeveniments)
                const coherenceDonation = {
                    date: new Date().toISOString().split('T')[0],
                    center: 'Hospital Coher√®ncia Test',
                    type: 'Sang',
                    volume: 450
                };

                UserDataManager.addDonation(coherenceDonation);

                // Verificar coher√®ncia
                const afterData = UserDataManager.getCurrentUserData();
                const afterDonations = afterData.donations.totalCount;
                const afterNotifications = afterData.notifications.list.length;
                const afterEvents = UserDataManager.loadDonationsToCalendar().length;

                // Verificar donaci√≥
                if (afterDonations === beforeDonations + 1) {
                    addResult('coherenceTest', true, '‚úÖ Donaci√≥ afegida');
                } else {
                    addResult('coherenceTest', false, '‚ùå Donaci√≥ NO afegida correctament');
                }

                // Verificar notificacions (hauria de crear almenys 2: confirmaci√≥ + propera data)
                if (afterNotifications > beforeNotifications) {
                    addResult('coherenceTest', true,
                        `‚úÖ Notificacions creades (+${afterNotifications - beforeNotifications})`);
                } else {
                    addResult('coherenceTest', false, '‚ùå No s\'han creat notificacions');
                }

                // Verificar esdeveniments al calendari
                if (afterEvents > beforeEvents) {
                    addResult('coherenceTest', true,
                        `‚úÖ Esdeveniments al calendari (+${afterEvents - beforeEvents})`);
                } else {
                    addResult('coherenceTest', false, '‚ùå No s\'han creat esdeveniments');
                }

                addResult('coherenceTest', true, 'Estat final',
                    `Donacions: ${afterDonations}\nNotificacions: ${afterNotifications}\nEventos: ${afterEvents}`);

            } catch (error) {
                addResult('coherenceTest', false, 'Error en test de coher√®ncia', error.message);
            }
        }
    </script>
</body>

</html>